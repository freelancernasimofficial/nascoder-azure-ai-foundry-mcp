name: ğŸ” CI - Build & Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20, 22]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”¨ Build project
        run: npm run build

      - name: ğŸ§ª Run tests
        run: npm test

      - name: âœ… Validate build artifacts
        run: |
          echo "ğŸ” Checking build artifacts..."
          if [ ! -f "dist/server.js" ]; then
            echo "âŒ Missing: dist/server.js"
            exit 1
          fi
          if [ ! -d "dist/azure" ]; then
            echo "âŒ Missing: dist/azure directory"
            exit 1
          fi
          if [ ! -d "dist/tools" ]; then
            echo "âŒ Missing: dist/tools directory"
            exit 1
          fi
          echo "âœ… All build artifacts present"

      - name: ğŸ“Š Check package size
        run: |
          echo "ğŸ“¦ Package contents:"
          npm pack --dry-run
          
      - name: ğŸ” Lint check (if available)
        run: |
          if npm run lint --if-present; then
            echo "âœ… Linting passed"
          else
            echo "â„¹ï¸ No linting configured"
          fi
        continue-on-error: true

  security:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”’ Security audit
        run: npm audit --audit-level=moderate

      - name: ğŸ” Check for outdated packages
        run: npm outdated || true

  compatibility:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”¨ Build project
        run: npm run build

      - name: ğŸ§ª Test server startup
        run: |
          echo "ğŸš€ Testing server startup..."
          timeout 10s node dist/server.js --help || true
          echo "âœ… Server startup test completed"

      - name: ğŸ“‹ Validate package.json
        run: |
          echo "ğŸ” Validating package.json..."
          node -e "
            const pkg = require('./package.json');
            console.log('âœ… Package name:', pkg.name);
            console.log('âœ… Version:', pkg.version);
            console.log('âœ… Main entry:', pkg.main);
            console.log('âœ… Binary:', pkg.bin);
            if (!pkg.main || !pkg.bin) {
              console.error('âŒ Missing main or bin field');
              process.exit(1);
            }
            console.log('âœ… Package validation passed');
          "
