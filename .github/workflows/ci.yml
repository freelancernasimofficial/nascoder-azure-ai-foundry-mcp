name: 🔍 CI - Build & Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20, 22]

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🟢 Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🔨 Build project
        run: npm run build

      - name: 🧪 Run tests
        run: npm test

      - name: ✅ Validate build artifacts
        run: |
          echo "🔍 Checking build artifacts..."
          if [ ! -f "dist/server.js" ]; then
            echo "❌ Missing: dist/server.js"
            exit 1
          fi
          if [ ! -d "dist/azure" ]; then
            echo "❌ Missing: dist/azure directory"
            exit 1
          fi
          if [ ! -d "dist/tools" ]; then
            echo "❌ Missing: dist/tools directory"
            exit 1
          fi
          echo "✅ All build artifacts present"

      - name: 📊 Check package size
        run: |
          echo "📦 Package contents:"
          npm pack --dry-run
          
      - name: 🔍 Lint check (if available)
        run: |
          if npm run lint --if-present; then
            echo "✅ Linting passed"
          else
            echo "ℹ️ No linting configured"
          fi
        continue-on-error: true

  security:
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🔒 Security audit
        run: npm audit --audit-level=moderate

      - name: 🔍 Check for outdated packages
        run: npm outdated || true

  compatibility:
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🔨 Build project
        run: npm run build

      - name: 🧪 Test server startup
        run: |
          echo "🚀 Testing server startup..."
          timeout 10s node dist/server.js --help || true
          echo "✅ Server startup test completed"

      - name: 📋 Validate package.json
        run: |
          echo "🔍 Validating package.json..."
          node -e "
            const pkg = require('./package.json');
            console.log('✅ Package name:', pkg.name);
            console.log('✅ Version:', pkg.version);
            console.log('✅ Main entry:', pkg.main);
            console.log('✅ Binary:', pkg.bin);
            if (!pkg.main || !pkg.bin) {
              console.error('❌ Missing main or bin field');
              process.exit(1);
            }
            console.log('✅ Package validation passed');
          "
